import{h as ze,r as d,j as a,D as S}from"./index-Dpbc67ik.js";import{D as re,F as te,A as le,I as Le}from"./Delete-BaXsfEQD.js";import{C as $e}from"./Container-C934OJCW.js";import{B as k}from"./Box-DQsBwXvn.js";import{C as Ue,a as Je,D as Me}from"./CardContent-CPfDlqPi.js";import{G as h}from"./Grid-BKhrTn5E.js";import{T as _,F as se}from"./TextField-B4yARQua.js";import{B as V}from"./Button-BH6ERtgr.js";import{T,P as Z,L as Ge,I as ie}from"./IconButton-henUlnG1.js";import{R as He,a as A,L as Ve}from"./RadioGroup-BSqrpN32.js";import{F as W}from"./FormControlLabel-BFJUOvXx.js";import{T as ne,a as oe,b as de,c as B,d as p,e as me}from"./TableRow-BFdZ0Yr8.js";import"./createSvgIcon-BHe6x9CX.js";import"./styled-BY3TOymu.js";import"./dividerClasses-BKrNzom6.js";const _a=Ze=>{const O=ze(e=>e.userInfo),[b,P]=d.useState(O.whitelevel_id),[z,D]=d.useState(new Date().toISOString().split("T")[0]),[v,L]=d.useState(""),[x,C]=d.useState("4"),[w,E]=d.useState(""),[ce,$]=d.useState(!1),[Xe,Qe]=d.useState([]),[Ke,Ye]=d.useState([]),[N,F]=d.useState(""),[U,j]=d.useState(!1),[J,R]=d.useState(""),[ea,aa]=d.useState({option1:!1}),[u,f]=d.useState([]),[o,g]=d.useState([{employee_id:"",employee_name:"",manual:!1,disableNameField:!1}]),[q,M]=d.useState([]),[pe,X]=d.useState(null),[ue,he]=d.useState(null),[ye,I]=d.useState({}),[Q,ra]=d.useState(null),[c,y]=d.useState({trainingDate:"",trainingId:"",whitelevelId:"",trainingType:"",trainingName:"",rows1:"",rows:"",image:"",about_the_training:""}),[K,ge]=d.useState(!1),fe=e=>/^[a-zA-Z\s.]*$/.test(e),G=(e,r)=>{const t=e.map(n=>n.employee_id),s=r.map(n=>n.employee_id);return t.filter(n=>s.includes(n)).length>0},Y=async e=>{try{return(await S.post("/employee/name/",{employee_id:e,whitelevel_id:b})).data.employee_name||""}catch(r){return console.error("Error fetching employee name:",r),""}},_e=async e=>{try{return(await S.get(`/employee/search/?nameQuery=${e}`)).data||[]}catch(r){return console.error("Error fetching employee suggestions:",r),[]}},be=()=>{if(u.some(t=>typeof t.employee_id=="string"&&t.employee_id.trim()===""||typeof t.employee_name=="string"&&t.employee_name.trim()==="")){alert("Please fill in all the fields before adding a new row.");const t=u.map(s=>({...s,error:typeof s.employee_id=="string"&&s.employee_id.trim()===""||typeof s.employee_name=="string"&&s.employee_name.trim()===""?"empty_field":s.error}));f(t),console.log("Updated rows after adding a row with empty fields:",t);return}const r=[...u,{employee_id:"",whitelevel_id:b,employee_name:"",error:null,disableNameField:!1}];f(r),console.log("Updated rows after adding a new row:",r)},xe=()=>{if(o.length===0||o[o.length-1].employee_id&&(o[o.length-1].employee_name||o[o.length-1].name))g([...o,{employee_id:"",whitelevel_id:b,employee_name:"",name:"",error:"",manual:!1,employee_id_error:!1,employee_name_error:!1,disableNameField:!1,invalidCharacterError:!1}]);else{const r=[...o];o[o.length-1].employee_id||(r[o.length-1].employee_id_error=!0),o[o.length-1].employee_name||o[o.length-1].name||(r[o.length-1].employee_name_error=!0),g(r)}},je=e=>{const r=u.filter((t,s)=>s!==e);f(r),console.log("Updated rows after deleting a row:",r)},Te=e=>{const r=o.filter((t,s)=>s!==e);g(r),console.log("Updated rows after deleting a row:",r)},ve=async(e,r)=>{const{name:t,value:s}=r.target,l=[...u];if(l[e][t]=s.trim(),t==="employee_id")if(l.some((i,m)=>i.employee_id===s&&m!==e))l[e].error="duplicate",l[e].employee_name="",l[e].disableNameField=!0;else if(s.trim()!==""){const i=await Y(s);i?(l[e].employee_name=i,l[e].error=null,l[e].disableNameField=!0):(l[e].employee_name="",l[e].error="invalid",l[e].disableNameField=!0)}else l[e].employee_name="",l[e].error=null,l[e].disableNameField=!1;f(l),console.log("Updated rows after employee_id input change:",l)},we=e=>{let r={};if(Q==="rows1"&&(g(e),K)){let t=[],s=!1;if(e.forEach((l,n)=>{l.employee_id!=="0"&&(!l.employee_id||!l.employee_name)&&(t.push(`Trainer ${n+1} has empty fields.`),s=!0)}),s){r.rows1=t.join(" "),y(r);return}G(e,u)?(r.rows1="Trainer and Trainee employee codes should not be equal",r.rows="Trainer and Trainee employee codes should not be equal",y(r)):(r.rows1="",r.rows="",y(r))}if(Q==="rows"&&(f(e),K)){let t=[],s=!1;if(e.forEach((l,n)=>{l.employee_id!=="0"&&(!l.employee_id||!l.employee_name)&&(t.push(`Trainee ${n+1} has empty fields.`),s=!0)}),s){r.rows=t.join(" "),y(r);return}G(o,u)?(r.rows1="Trainer and Trainee employee codes should not be equal",r.rows="Trainer and Trainee employee codes should not be equal",y(r)):(r.rows="",r.rows1="",y(r))}},ee=async(e,r)=>{const{name:t,value:s}=r.target,l=[...o];if(t==="employee_name"||t==="name")if(fe(s))l[e].invalidCharacterError=!1;else{l[e].invalidCharacterError=!0,g(l);return}if(l[e][t]=s,t==="employee_id")if(l[e].employee_id_error=!1,l[e].error="",s==="0")l[e].employee_name="",l[e].manual=!0,l[e].disableNameField=!1;else{const n=l.some((i,m)=>i.employee_id===s&&m!==e);if(l[e].error=n?"duplicate":"",n)l[e].disableNameField=!0;else{const i=await Y(s);i?(l[e].employee_name=i,l[e].manual=!1,l[e].disableNameField=!0):(l[e].error="invalid",l[e].employee_name="",l[e].disableNameField=!0)}}else if(t==="employee_name")if(s.length>0)if(l.some((i,m)=>i.employee_name===s&&m!==e))l[e].error="duplicate",l[e].disableIDField=!0;else{const i=await _e(s);M(m=>({...m,[e]:i})),I(m=>({...m,[e]:!0})),l[e].disableIDField=!1}else M(n=>({...n,[e]:[]})),I(n=>({...n,[e]:!1}));else l[e].employee_name_error=!1,t==="name"&&o[e].employee_id==="0"&&(l[e].employee_name_error=!1,l[e].error="");g(l)},Ie=(e,r)=>{const t=[...u];t.some(l=>l.employee_id===r.employee_id&&l!==t[e])?(t[e].error="duplicate",t[e].disableNameField=!0):(t[e].employee_id=r.employee_id,t[e].employee_name=r.employee_name,t[e].error=null,t[e].disableNameField=!0),f(t),M([]),he(null),console.log("Updated rows after suggestion click:",t)},Se=e=>{X(e)},De=()=>{X(null)},Ce=async e=>{const{name:r,checked:t}=e.target;if(v){j(!0),j(!0);try{const s=await S.post("/training/training-details/",{training_id:v,whitelevel_id:b}),l=s.data;l?(D(l.training_date),C(l.training_type),E(l.training_name),g(l.trainers.map(n=>({employee_id:n.employee_id,employee_name:n.trainer_name}))),f(l.trainees.map(n=>({employee_id:n.employee_id,employee_name:n.trainee_name}))),F(l.training_image),R(l.about_the_training)):alert("No SafetyTraining data found. Please check the reference number."),console.log("Fetched data:",s.data)}catch(s){console.error("Error fetching accident data:",s),y({fetch:"Failed to fetch accident data. Please try again."})}finally{j(!1)}}},Ee=e=>{P(e.target.value)},Ne=e=>{D(e.target.value)},Fe=e=>{const r=e.target.value;C(r),$(r==="1"),y({...c,trainingType:r===""?"Training Type is required":""})},Re=e=>{const r=e.target.value,t=/^[A-Za-z\s]*$/;E(r),x==="1"&&(t.test(r)?y({...c,trainingName:""}):y({...c,trainingName:"Training Name must contain only alphabets and spaces"}))},qe=e=>{L(e.target.value)},ke=e=>{R(e.target.value)},Ae=new Date().toISOString().split("T")[0],ae=()=>{P(O.whitelevel_id),D(new Date().toISOString().split("T")[0]),L(""),C("4"),E(""),$(!1),f([]),g([]),F(""),R("")},We=async e=>{var l,n;e.preventDefault(),j(!0),ge(!0),we();let r=!0;const t={trainingDate:z?"":"Training Date is required",trainingId:v?"":"Training ID is required",whitelevelId:b?"":"Whitelevel ID is required",trainingType:x?"":"Training Type is required",trainingName:x==="1"&&!w?"Training Name is required":"",rows1:o.length===0?"At least one Trainer is required":"",rows:u.length===0?"At least one Trainee is required":""};if(x==="1"&&(w?/^[A-Za-z\s]*$/.test(w)||(t.trainingName="Training Name must contain only alphabets and spaces",r=!1):(t.trainingName="Training Name is required",r=!1)),Object.keys(t).forEach(i=>{t[i]&&(r=!1)}),o.forEach((i,m)=>{i.employee_id!=="0"&&(!i.employee_id||!i.employee_name)&&(t[`trainer_${m}_name`]="Trainer name is required",r=!1)}),u.forEach((i,m)=>{i.employee_id_id!=="0"&&(!i.employee_id||!i.employee_name)&&(t[`trainee_${m}_name`]="Trainee name is required",r=!1)}),G(o,u)&&(t.rows1="Trainer and Trainee employee codes should not be equal",t.rows="Trainer and Trainee employee codes should not be equal",r=!1),y(t),!r){j(!1);return}const s={training_id:v,training_date:z,whitelevel_id:b,training_type:x,training_image:N,about_the_training:J,training_name:x==="1"?w:null,trainers:o.map(({employee_id:i,whitelevel_id:m,employee_name:H})=>({trainer_id:i,whitelevel_id:m,trainer_name:H})),trainees:u.map(({employee_id:i,employee_name:m,whitelevel_id:H})=>({trainee_id:i,whitelevel_id:H,trainee_name:m}))};console.log("Submitting the following data:"),console.log(JSON.stringify(s,null,2));try{const i=await S.post("/training/start/",s);console.log("Success:",i.data),window.alert("Safety Training Form submitted successfully!"),ae(),P(O.whitelevel_id),D(new Date().toISOString().split("T")[0]),L(""),C("4"),E(""),$(!1),g([]),f([]),F(""),R("")}catch(i){if(i.response){console.error(`HTTP error! Status: ${i.response.status}`);const m=JSON.stringify(i.response.data);console.error("Response body:",m),((n=(l=i.response.data)==null?void 0:l.training_id)==null?void 0:n[0])==="training with this training id already exists."?window.alert("Training ID already exists. Please use a different ID."):window.alert("Error submitting form. Please check the details and try again.")}else i.isAxiosError?(console.error("Axios error:",i.message),window.alert("An error occurred with the request. Please try again.")):i.name==="TypeError"?(console.error("Network error: Please check if the server is running and accessible."),window.alert("Network error: Please check if the server is running and accessible.")):(console.error("Error fetching data:",i.message),window.alert(`Error fetching data: ${i.message}`))}finally{j(!1)}},Be=async e=>{e.preventDefault(),j(!0);const r={training_id:v,training_type:x,training_name:w,whitelevel_id:b,image:N,about_the_training:J,training_image:N,trainers:o.map(({employee_id:t,whitelevel_id:s,employee_name:l})=>({employee_id:t,whitelevel_id:s,trainer_name:l})),trainees:u.map(({employee_id:t,employee_name:s,whitelevel_id:l})=>({employee_id:t,whitelevel_id:l,trainee_name:s}))};console.log(JSON.stringify(r,null,2));try{const t=await S.put("/training/training-details-update/",r);console.log("Updated Training:",t.data),alert("Updated Training SucessFully:",t.data),ae()}catch(t){console.error("Error:",t),y("An error occurred while updating the accident.")}finally{j(!1)}},Oe=(e,r)=>{const t=[...o];t.some((l,n)=>l.employee_name===r.employee_name&&n!==e)?(t[e].error="duplicate",t[e].employee_id_error=!0,t[e].employee_name=r.employee_name,t[e].employee_id="",t[e].disableIDField=!0):(t[e].employee_name=r.employee_name,t[e].employee_id=r.employee_id,t[e].manual=!1,t[e].error="",t[e].employee_id_error=!1,t[e].disableIDField=!1),I(l=>({...l,[e]:!1})),g(t)},Pe=e=>{setTimeout(()=>{I(r=>({...r,[e]:!1}))},200)};return a.jsx($e,{maxWidth:"xl",children:a.jsx(k,{className:"section",sx:{display:"flex",justifyContent:"center",padding:4},children:a.jsx("form",{onSubmit:We,children:a.jsx(Ue,{sx:{width:"100%",padding:3,boxShadow:3},children:a.jsx(Je,{children:a.jsxs(h,{container:!0,spacing:3,children:[a.jsx(h,{item:!0,xs:12,sm:5.5,children:a.jsx(_,{label:"Date",type:"date",fullWidth:!0,InputLabelProps:{shrink:!0},inputProps:{max:new Date().toISOString().split("T")[0]},value:z,onChange:Ne,max:Ae,error:!!c.trainingDate,helperText:c.trainingDate,required:!0})}),a.jsx(h,{item:!0,xs:12,sm:5.5,children:a.jsx(_,{label:"Reference Number",fullWidth:!0,value:v,onChange:qe,error:!!c.trainingId,helperText:c.trainingId})}),a.jsx(h,{item:!0,xs:12,sm:1,sx:{marginTop:"10px"},children:a.jsx(V,{variant:"contained",color:"secondary",onClick:Ce,fullWidth:!0,disabled:U,children:"ok"})}),a.jsxs(h,{item:!0,xs:12,children:[a.jsx(T,{variant:"h6",style:{display:"none"},children:"Whitelevel ID:"}),a.jsx(se,{fullWidth:!0,margin:"normal",style:{display:"none"},children:a.jsx(_,{style:{display:"none"},label:"Whitelevel ID",fullWidth:!0,value:b,onChange:Ee,error:!!c.whitelevelId,helperText:c.whitelevelId})})]}),a.jsxs(h,{item:!0,xs:12,children:[a.jsx(T,{variant:"h6",sx:{marginBottom:1},required:!0,children:"Training Type *:"}),a.jsxs(He,{row:!0,value:x,onChange:Fe,children:[a.jsx(W,{value:"4",control:a.jsx(A,{}),label:"Tool box Training"}),a.jsx(W,{value:"3",control:a.jsx(A,{}),label:"Job & Safety"}),a.jsx(W,{value:"2",control:a.jsx(A,{}),label:"Behavioural"}),a.jsx(W,{value:"1",control:a.jsx(A,{}),label:"Others"})]}),ce&&a.jsx(_,{label:"Name of Training",fullWidth:!0,value:w,onChange:Re,error:!!c.trainingName,helperText:c.trainingName}),c.trainingType&&a.jsx(T,{variant:"body2",color:"error",sx:{mt:1},children:c.trainingType})]}),a.jsxs(h,{item:!0,xs:12,children:[a.jsx(Me,{sx:{marginBottom:3}}),a.jsx(T,{variant:"h6",children:"TRAINER *: (Enter 0 in case of Others)"}),a.jsxs(k,{sx:{position:"relative"},children:[c.rows1&&a.jsx(T,{variant:"body2",color:"error",sx:{mt:1},children:c.rows1}),a.jsx(ne,{component:Z,sx:{border:"1px solid lightgrey",borderRadius:"8px",boxShadow:"none"},children:a.jsxs(oe,{children:[a.jsx(de,{children:a.jsxs(B,{children:[a.jsx(p,{children:"Sl. No"}),a.jsx(p,{sx:{pl:12},children:"Employee ID"}),a.jsx(p,{sx:{pl:12},children:"Employee Name"}),a.jsx(p,{sx:{pl:2},children:"Actions"})]})}),a.jsx(me,{children:o.map((e,r)=>a.jsxs(B,{children:[a.jsx(p,{children:r+1}),a.jsx(p,{children:a.jsx(_,{variant:"outlined",size:"small",name:"employee_id",value:e.employee_id!==0?e.employee_id:"",onChange:t=>ee(r,t),fullWidth:!0,required:!0,error:!!e.error||e.employee_id_error,helperText:e.error==="duplicate"?"Duplicate employee ID":e.error==="invalid"?"Employee does not exist":e.employee_id_error?"Employee ID is required":"",disabled:e.disableIDField,onFocus:()=>I(t=>({...t,[r]:!1}))})}),a.jsxs(p,{children:[a.jsx(_,{variant:"outlined",size:"small",name:"employee_name",value:e.employee_id==="0"?e.name||e.employee_name:e.employee_name||"",onChange:t=>ee(r,t),onBlur:()=>Pe(r),fullWidth:!0,required:!0,disabled:e.disableNameField,error:e.employee_name_error||e.invalidCharacterError,helperText:e.invalidCharacterError?"Invalid characters in employee name":e.employee_name_error?"Employee name is required":""}),ye[r]&&q[r]&&a.jsx(Z,{sx:{position:"absolute",zIndex:1,maxWidth:"300px"},children:a.jsx(Ge,{sx:{maxHeight:200,overflow:"auto"},children:q[r].map((t,s)=>a.jsx(Ve,{button:!0,onClick:()=>Oe(r,t),children:`${t.employee_name}`},s))})})]}),a.jsx(p,{children:a.jsx(ie,{color:"primary",onClick:()=>Te(r),children:a.jsx(re,{})})})]},r))})]})}),a.jsx(te,{color:"primary",size:"small",onClick:xe,sx:{position:"absolute",bottom:-18,left:"49%",transform:"translateX(-50%)",boxShadow:"none",zIndex:1},children:a.jsx(le,{})})]})]}),a.jsxs(h,{item:!0,xs:12,children:[a.jsx(T,{variant:"h6",children:"TRAINEE *:"}),a.jsxs(k,{sx:{position:"relative",backgroundColor:"#FAF9F6"},children:[c.rows&&a.jsx(T,{variant:"body2",color:"error",sx:{mt:1},children:c.rows}),a.jsx(ne,{component:Z,sx:{border:"1px solid lightgrey",borderRadius:"8px",boxShadow:"none"},children:a.jsxs(oe,{children:[a.jsx(de,{children:a.jsxs(B,{children:[a.jsx(p,{children:"Sl. No"}),a.jsx(p,{sx:{pl:12},children:"Employee ID"}),a.jsx(p,{sx:{pl:12},children:"Employee Name"}),a.jsx(p,{children:"Actions"})]})}),a.jsx(me,{children:u.map((e,r)=>a.jsxs(B,{children:[a.jsx(p,{children:r+1}),a.jsx(p,{children:a.jsx(_,{variant:"outlined",size:"small",name:"employee_id",value:e.employee_id,onChange:t=>ve(r,t),fullWidth:!0,required:!0,error:!!e.error,helperText:e.error==="duplicate"?"Duplicate employee ID":e.error==="invalid"?"Employee does not exist":e.error==="empty_field"?"Employee ID should not be empty":"",disabled:e.disableIDField})}),a.jsxs(p,{children:[a.jsx(_,{variant:"outlined",size:"small",name:"employee_name",value:e.employee_name,onChange:t=>handleNameInputChange(r,t),fullWidth:!0,required:!0,error:!!e.error,helperText:e.error==="invalid_name"?"Invalid characters. Only letters, spaces, and dots are allowed.":e.error==="name_mismatch"?"Incorrect name for the given Employee ID":e.error==="duplicate_name"?"Duplicate employee name":e.error==="empty_field"?"Employee Name should not be empty":"",disabled:e.disableNameField}),r===ue&&q.length>0&&a.jsx("div",{style:{position:"absolute",zIndex:1e3,width:"100%",backgroundColor:"#fff",border:"1px solid lightgrey",borderRadius:"4px",boxShadow:"0px 4px 8px rgba(0,0,0,0.2)",marginTop:"4px"},children:q.map((t,s)=>a.jsx("div",{style:{padding:"8px",backgroundColor:pe===s?"#f0f0f0":"#fff",cursor:"pointer"},onMouseEnter:()=>Se(s),onMouseLeave:De,onClick:()=>Ie(r,t),children:t.employee_name},t.employee_id))})]}),a.jsx(p,{children:a.jsx(ie,{"aria-label":"delete",onClick:()=>je(r),children:a.jsx(re,{})})})]},r))})]})}),a.jsx(k,{mt:2,children:a.jsx(te,{size:"small",color:"primary","aria-label":"add",onClick:be,sx:{position:"absolute",bottom:-18,left:"49%",transform:"translateX(-50%)",boxShadow:"none",zIndex:1},children:a.jsx(le,{})})})]})]}),a.jsx(h,{item:!0,xs:12,children:a.jsx(se,{fullWidth:!0,margin:"normal",children:a.jsx(_,{label:"Description",multiline:!0,rows:4,value:J,onChange:ke})})}),a.jsx(h,{item:!0,xs:12,children:a.jsx(Le,{setCompressedImageBase64:F,compressedImageBase64:N})}),a.jsxs(h,{container:!0,spacing:2,sx:{marginTop:"20px"},children:[a.jsx(h,{item:!0,xs:12,md:6,children:a.jsx(V,{variant:"contained",color:"primary",type:"submit",fullWidth:!0,disabled:U,children:"Submit"})}),a.jsx(h,{item:!0,xs:12,md:6,children:a.jsx(V,{variant:"contained",color:"secondary",onClick:Be,fullWidth:!0,disabled:U,children:"Update"})})]})]})})})})})})};export{_a as default};
