import{h as je,r as l,j as s,D as b}from"./index-C3ctIiJl.js";import{D as be,F as Se,A as we,I as De}from"./Delete-BZ0mw7gd.js";import{B as h}from"./Box-FC9Y7n6T.js";import{B as Ee,T as f,P as Ie,I as ve}from"./IconButton-Cmlk01-7.js";import{C as Ce}from"./CircularProgress-Bxkk8ski.js";import{C as Te,a as Pe,D as ae}from"./CardContent-Bi_GZMkN.js";import{G as _}from"./Grid-Dp_0KShC.js";import{T as E,F as P}from"./TextField-hedXIXYF.js";import{B as G}from"./Button-U5nG2xrk.js";import{F as S}from"./FormControlLabel-DdBEyN_E.js";import{C as w}from"./Checkbox-CL-TNf1D.js";import{T as Re,a as Ne,b as Fe,c as oe,d as j,e as Oe}from"./TableRow-BTX8zteK.js";import"./createSvgIcon-CNOz48qt.js";import"./dividerClasses-BVDnDaWy.js";import"./styled-CuzW6_nN.js";const is=()=>{const Z=je(e=>e.userInfo),[d,R]=l.useState({TOOLS:!1,PPE:!1,DRESS:!1}),[N,H]=l.useState([]),[F,Q]=l.useState([]),[O,V]=l.useState([]),[I,B]=l.useState(new Date().toISOString().split("T")[0]),[y,X]=l.useState(""),[L,Be]=l.useState(Z.whitelevel_id),[A,k]=l.useState(""),[Le,Ae]=l.useState([]),[c,v]=l.useState({}),[C,T]=l.useState(!1),[U,z]=l.useState(""),[p,J]=l.useState({tools:[],ppes:[],dresses:[]}),[ke,Ue]=l.useState({option1:!1}),[ze,We]=l.useState({}),[qe,$e]=l.useState({}),[Me,Ge]=l.useState({}),[u,x]=l.useState([]),[K,W]=l.useState([]),[re,Y]=l.useState(null),[le,q]=l.useState(null),[ee,Ze]=l.useState(Z.whitelevel_id),se=async e=>{try{return(await b.post("/employee/name/",{employee_id:e,whitelevel_id:ee})).data.employee_name||""}catch(o){return console.error("Error fetching employee name:",o),""}},ne=async e=>{try{return(await b.get(`/employee/search/?nameQuery=${e}`)).data||[]}catch(o){return console.error("Error fetching employee suggestions:",o),[]}},ie=()=>{if(u.some(t=>t.employee_id.trim()===""||t.employee_name.trim()==="")){alert("Please fill in all the fields before adding a new row.");const t=u.map(a=>({...a,error:a.employee_id.trim()===""||a.employee_name.trim()===""?"empty_field":a.error}));x(t),console.log("Updated rows after adding a row with empty fields:",t);return}const o=[...u,{employee_id:"",whitelevel_id:ee,employee_name:"",error:null,disableNameField:!1}];x(o),console.log("Updated rows after adding a new row:",o)},ce=e=>{const o=u.filter((t,a)=>a!==e);x(o),console.log("Updated rows after deleting a row:",o)},me=async(e,o)=>{const{name:t,value:a}=o.target,r=[...u];if(r[e][t]=a.trim(),t==="employee_id")if(r.some((n,g)=>n.employee_id===a&&g!==e))r[e].error="duplicate",r[e].employee_name="",r[e].disableNameField=!0;else if(a.trim()!==""){const n=await se(a);n?(r[e].employee_name=n,r[e].error=null,r[e].disableNameField=!0):(r[e].employee_name="",r[e].error="invalid",r[e].disableNameField=!0)}else r[e].employee_name="",r[e].error=null,r[e].disableNameField=!1;x(r),console.log("Updated rows after employee_id input change:",r)},de=async(e,o)=>{const t=o.target.value,a=[...u];if(/^[a-zA-Z\s.]*$/.test(t)){if(a[e].employee_name=t,t.trim()!=="")if(a.some((g,D)=>g.employee_name===t&&D!==e))a[e].error="duplicate_name",a[e].disableIDField=!0;else{const g=await ne(t);W(g),q(e),a[e].disableIDField=!1}else W([]),q(null),a[e].disableIDField=!1;const i=await se(a[e].employee_id);t.trim()!==i?a[e].error="name_mismatch":a[e].error=null}else a[e].error="invalid_name";x(a),console.log("Updated rows after employee_name input change:",a)},pe=(e,o)=>{const t=[...u];t.some(r=>r.employee_id===o.employee_id&&r!==t[e])?(t[e].error="duplicate",t[e].disableNameField=!0):(t[e].employee_id=o.employee_id,t[e].employee_name=o.employee_name,t[e].error=null,t[e].disableNameField=!0),x(t),W([]),q(null),console.log("Updated rows after suggestion click:",t)},ue=e=>{Y(e)},he=()=>{Y(null)};l.useEffect(()=>{(async()=>{try{const t=(await b.get("/item/getAll/")).data,a=t.filter(n=>n.item_type.item_type_name==="Tool"),r=t.filter(n=>n.item_type.item_type_name==="PPE"),i=t.filter(n=>n.item_type.item_type_name==="Dress");J({tools:a,ppes:r,dresses:i})}catch(o){console.error("Error fetching items:",o)}})()},[]);const fe=async e=>{const{name:o,checked:t}=e.target;if(!y){alert("Issuance ID is required to fetch details.");return}try{const r=(await b.post("/item/get-details/",{issue_id:y,whitelevel_id:L})).data;if(r){B(r.new_issuance.issuance_date);const i={TOOLS:r.issued_things.some(m=>m.item_type_id==="1"),PPE:r.issued_things.some(m=>m.item_type_id==="2"),DRESS:r.issued_things.some(m=>m.item_type_id==="3")};R(i);const n=r.issued_things.filter(m=>m.item_type_id==="1"),g=r.issued_things.filter(m=>m.item_type_id==="2"),D=r.issued_things.filter(m=>m.item_type_id==="3");J({tools:n,ppes:g,dresses:D}),x(r.issued_to_employees.map(m=>({employee_id:m.employee,employee_name:m.employee_name}))),k(r.new_issuance.newIssuance_image),z(r.new_issuance.about_the_newissuance)}else alert("No issuance data found. Please check the reference number.")}catch(a){console.error("Error fetching issuance data:",a),v({fetch:"Failed to fetch issuance data. Please try again."})}},ye=async e=>{e.preventDefault(),T(!0);const o=[...F.map(a=>({item:a.item})),...N.map(a=>({item:a.item})),...O.map(a=>({item:a.item}))],t={issuance_id:y,whitelevel_id:L,issuance_date:I,newIssuance_image:A,about_the_newissuance:U,issued_things:o,issued_to_employees:u.map(({employee_id:a})=>({employee:a}))};try{const a=await b.put("item/newissuance-update/",t);console.log("Updated NewIssuance SucessFully:",a.data),alert("Updated NewIssuance SucessFully:",a.data),te()}catch(a){console.error("Error:",a),v("An error occurred while updating the NewIssuance.")}finally{T(!1)}},$=e=>{const{name:o,checked:t}=e.target;R(a=>({...a,[o]:t}))},M=(e,o)=>{const{name:t,checked:a}=e.target,r=(i,n,g)=>g?[...i,{item:n}]:i.filter(D=>D.item!==n);o==="TOOLS"&&Q(i=>r(i,t,a)),o==="PPE"&&H(i=>r(i,t,a)),o==="DRESS"&&V(i=>r(i,t,a))},ge=e=>{z(e.target.value)},_e=()=>{let e={};I||(e.issuance_date="Issuance date is required");const o=/^[A-Za-z0-9/-]+$/;return y?y.length<3||y.length>21?e.issuance_id="Reference number must be between 3 and 21 characters":o.test(y)||(e.issuance_id="Reference number can only contain letters, numbers, hyphens, and slashes"):e.issuance_id="Reference number is required",d.TOOLS&&F.length===0&&(e.tools="At least one tool must be selected"),d.PPE&&N.length===0&&(e.ppe="At least one PPE must be selected"),d.DRESS&&O.length===0&&(e.dress="At least one dress must be selected"),u.length===0?e.rows="Employee details are required":u.forEach(({employee_id:t,employee_name:a},r)=>{(!t||!a)&&(e.rows=`Employee ID and Name cannot be empty for entry #${r+1}`)}),!d.TOOLS&&!d.PPE&&!d.DRESS&&(e.items="At least one item category must be selected"),v(e),Object.keys(e).length===0},te=()=>{R({TOOLS:!1,PPE:!1,DRESS:!1}),H([]),Q([]),V([]),B(new Date().toISOString().split("T")[0]),X(""),k(""),v({}),z(""),x([])},xe=async()=>{if(!_e())return;T(!0);const e=[...F.map(t=>({item:t.item})),...N.map(t=>({item:t.item})),...O.map(t=>({item:t.item}))],o={issuance:{issuance_id:y,white_level_id:L,issuance_date:I,newIssuance_image:A||null,about_the_newissuance:U},issued_things:e,employees:u.map(({employee_id:t,employee_name:a,whitelevel_id:r})=>({employee_id:t,employee_name:a,whitelevel_id:r}))};try{const a=(await b.post("/item/new/",o)).data.message;console.log("Data submitted successfully:",a),alert("New Issuance Successfully submitted."),te()}catch(t){console.error("Error submitting data:",t),alert(`Error submitting data: ${t.message}`)}finally{T(!1)}};return s.jsxs(h,{className:"section",sx:{display:"flex",justifyContent:"center",padding:4},children:[s.jsx(Ee,{sx:{color:"#fff",zIndex:e=>e.zIndex.drawer+1},open:C,children:s.jsx(Ce,{color:"inherit"})}),s.jsx(Te,{sx:{width:"100%",padding:3},children:s.jsxs(Pe,{children:[s.jsxs(_,{container:!0,spacing:2,marginBottom:3,children:[s.jsx(_,{item:!0,xs:12,sm:5.5,children:s.jsx(E,{label:"Date*",type:"date",fullWidth:!0,InputLabelProps:{shrink:!0},inputProps:{max:new Date().toISOString().split("T")[0]},value:I,onChange:e=>B(e.target.value),error:!!c.issuance_date,helperText:c.issuance_date})}),s.jsx(_,{item:!0,xs:12,sm:5.5,children:s.jsx(E,{label:"Reference Number*",fullWidth:!0,value:y,onChange:e=>X(e.target.value),error:!!c.issuance_id,helperText:c.issuance_id})}),s.jsx(_,{item:!0,xs:12,sm:1,sx:{marginTop:"10px"},children:s.jsx(G,{variant:"contained",color:"secondary",onClick:fe,fullWidth:!0,disabled:C,children:"ok"})})]}),s.jsx(ae,{sx:{marginBottom:3}}),s.jsx(f,{variant:"h6",children:"Items*:"}),c.items&&s.jsx(f,{color:"error",children:c.items}),s.jsx(S,{control:s.jsx(w,{checked:d.TOOLS,onChange:$,name:"TOOLS"}),label:"TOOLS"}),s.jsx(S,{control:s.jsx(w,{checked:d.PPE,onChange:$,name:"PPE"}),label:"PPE"}),s.jsx(S,{control:s.jsx(w,{checked:d.DRESS,onChange:$,name:"DRESS"}),label:"DRESS"}),d.TOOLS&&s.jsxs(h,{marginBottom:3,children:[s.jsxs(P,{component:"fieldset",children:[s.jsx(f,{variant:"h6",children:"TOOLS"}),((p==null?void 0:p.tools)??[]).length>0?s.jsx(h,{display:"flex",justifyContent:"space-between",children:[...Array(4)].map((e,o)=>s.jsx(h,{display:"flex",flexDirection:"column",flex:"1 0 22%",marginRight:o<3?2:0,marginBottom:2,children:p.tools.slice(o*10,(o+1)*10).map(t=>s.jsx(S,{control:s.jsx(w,{onChange:a=>M(a,"TOOLS"),name:t.item_id}),label:t.item_name},t.item_id))},o))}):s.jsx(f,{children:"Loading tools..."})]}),c.tools&&s.jsx(f,{color:"error",children:c.tools})]}),d.PPE&&s.jsxs(h,{marginBottom:3,children:[s.jsxs(P,{component:"fieldset",children:[s.jsx(f,{variant:"h6",children:"PPE"}),((p==null?void 0:p.ppes)??[]).length>0?s.jsx(h,{display:"flex",justifyContent:"space-between",children:[...Array(4)].map((e,o)=>s.jsx(h,{display:"flex",flexDirection:"column",flex:"1 0 22%",marginRight:o<3?2:0,marginBottom:2,children:p.ppes.slice(o*10,(o+1)*10).map(t=>s.jsx(S,{control:s.jsx(w,{onChange:a=>M(a,"PPE"),name:t.item_id}),label:t.item_name},t.item))},o))}):s.jsx(f,{children:"Loading PPE..."})]}),c.ppe&&s.jsx(f,{color:"error",children:c.ppe})]}),d.DRESS&&s.jsxs(h,{marginBottom:3,children:[s.jsxs(P,{component:"fieldset",children:[s.jsx(f,{variant:"h6",children:"DRESS"}),((p==null?void 0:p.dresses)??[]).length>0?s.jsx(h,{display:"flex",justifyContent:"space-between",children:[...Array(4)].map((e,o)=>s.jsx(h,{display:"flex",flexDirection:"column",flex:"1 0 22%",marginRight:o<3?2:0,marginBottom:2,children:p.dresses.slice(o*10,(o+1)*10).map(t=>s.jsx(S,{control:s.jsx(w,{onChange:a=>M(a,"DRESS"),name:t.item_id}),label:t.item_name},t.item))},o))}):s.jsx(f,{children:"Loading dresses..."})]}),c.dress&&s.jsx(f,{color:"error",children:c.dress})]}),s.jsx(ae,{sx:{marginBottom:3}}),s.jsxs(h,{sx:{position:"relative",backgroundColor:"#FAF9F6"},children:[s.jsx(Re,{component:Ie,sx:{border:"1px solid lightgrey",borderRadius:"8px",boxShadow:"none"},children:s.jsxs(Ne,{children:[s.jsx(Fe,{children:s.jsxs(oe,{children:[s.jsx(j,{children:"Sl. No"}),s.jsx(j,{sx:{pl:12},children:"Employee ID"}),s.jsx(j,{sx:{pl:12},children:"Employee Name"}),s.jsx(j,{children:"Actions"})]})}),s.jsxs(Oe,{children:[c.rows&&s.jsx(f,{color:"error",children:c.rows}),u.map((e,o)=>s.jsxs(oe,{children:[s.jsx(j,{children:o+1}),s.jsx(j,{children:s.jsx(E,{variant:"outlined",size:"small",name:"employee_id",value:e.employee_id,onChange:t=>me(o,t),fullWidth:!0,required:!0,error:!!e.error,helperText:e.error==="duplicate"?"Duplicate employee ID":e.error==="invalid"?"Employee does not exist":e.error==="empty_field"?"Employee ID should not be empty":"",disabled:e.disableIDField})}),s.jsxs(j,{children:[s.jsx(E,{variant:"outlined",size:"small",name:"employee_name",value:e.employee_name,onChange:t=>de(o,t),fullWidth:!0,required:!0,error:!!e.error,helperText:e.error==="invalid_name"?"Invalid characters. Only letters, spaces, and dots are allowed.":e.error==="name_mismatch"?"Incorrect name for the given Employee ID":e.error==="duplicate_name"?"Duplicate employee name":e.error==="empty_field"?"Employee Name should not be empty":"",disabled:e.disableNameField}),o===le&&K.length>0&&s.jsx("div",{style:{position:"absolute",zIndex:1e3,width:"100%",backgroundColor:"#fff",border:"1px solid lightgrey",borderRadius:"4px",boxShadow:"0px 4px 8px rgba(0,0,0,0.2)",marginTop:"4px"},children:K.map((t,a)=>s.jsx("div",{style:{padding:"8px",backgroundColor:re===a?"#f0f0f0":"#fff",cursor:"pointer"},onMouseEnter:()=>ue(a),onMouseLeave:he,onClick:()=>pe(o,t),children:t.employee_name},t.employee_id))})]}),s.jsx(j,{children:s.jsx(ve,{"aria-label":"delete",onClick:()=>ce(o),children:s.jsx(be,{})})})]},o))]})]})}),s.jsx(h,{mt:2,children:s.jsx(Se,{size:"small",color:"primary","aria-label":"add",onClick:ie,sx:{position:"absolute",bottom:-18,left:"49%",transform:"translateX(-50%)",boxShadow:"none",zIndex:1},children:s.jsx(we,{})})})]}),s.jsx(_,{item:!0,xs:12,children:s.jsx(P,{fullWidth:!0,margin:"normal",children:s.jsx(E,{label:"Description....",multiline:!0,rows:4,value:U,onChange:ge})})}),s.jsx(_,{item:!0,xs:12,children:s.jsx(De,{setCompressedImageBase64:k,compressedImageBase64:A})}),s.jsxs(_,{container:!0,spacing:2,sx:{marginTop:"20px"},children:[s.jsx(_,{item:!0,xs:12,md:6,children:s.jsx(G,{variant:"contained",color:"primary",type:"submit",fullWidth:!0,disabled:C,onClick:xe,children:"Submit"})}),s.jsx(_,{item:!0,xs:12,md:6,children:s.jsx(G,{variant:"contained",color:"secondary",onClick:ye,fullWidth:!0,disabled:C,children:"Update NewIssuance"})})]})]})})]})};export{is as default};
