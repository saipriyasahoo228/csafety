import{h as oe,r as d,j as e,D as H}from"./index-C3ctIiJl.js";import{D as ge,F as je,A as be,I as ve}from"./Delete-BZ0mw7gd.js";import{B as w}from"./Box-FC9Y7n6T.js";import{T as Se,a as Ie,b as Ce,c as te,d as D,e as Ee}from"./TableRow-BTX8zteK.js";import{P as se,L as Te,I as we,T as g,B as De}from"./IconButton-Cmlk01-7.js";import{T as q,F as W,a as U}from"./TextField-hedXIXYF.js";import{L as ke,R as G,a as y}from"./RadioGroup-C5t3M9qU.js";import{T as Ne}from"./Training4-C7RZ_4D1.js";import{C as Re}from"./Container-CwrVfLUr.js";import{C as Ae,a as Fe,D as Be}from"./CardContent-Bi_GZMkN.js";import{G as h}from"./Grid-Dp_0KShC.js";import{B as ee}from"./Button-U5nG2xrk.js";import{F as _}from"./FormControlLabel-DdBEyN_E.js";import{C as Pe}from"./CircularProgress-Bxkk8ski.js";import"./createSvgIcon-CNOz48qt.js";import"./styled-CuzW6_nN.js";import"./dividerClasses-BVDnDaWy.js";const ae=({onEmployeesChange:O,initialData:j})=>{const V=oe(r=>r.userInfo),[n,S]=d.useState(j||[]),[E,N]=d.useState(V.whitelevel_id),[f,k]=d.useState({}),[R,T]=d.useState({});d.useEffect(()=>{if(Array.isArray(j)&&j.length>0&&n.length===0){console.log("initialData :",j);const r=j.map(s=>({...s,employee_id:s.trainer_id,employee_name:s.trainer_name}));console.log("Updated Rows:",r),S(r)}},[j]);const b=async(r,s)=>{try{return(await H.post("/employee/name/",{employee_id:r,whitelevel_id:s})).data.employee_name||""}catch(a){return console.error("Error fetching employee name:",a),""}},Y=async r=>{try{return(await H.get(`/employee/search/?nameQuery=${r}`)).data||[]}catch(s){return console.error("Error fetching employee suggestions:",s),[]}};d.useEffect(()=>{O(n.map(r=>({employee:r.employee_id,whitelevel_id:E,employee_id:r.employee_id==="0"?"":r.employee_id,employee_name:r.employee_id==="0"?r.name:r.employee_name,trainer_id:r.employee_id,trainer_name:r.employee_id==="0"?r.name:r.employee_name,trainee_id:r.employee_id==="0"?"":r.employee_id,trainee_name:r.employee_id==="0"?"":r.employee_name})))},[n,O]);const A=r=>/^[a-zA-Z\s.]*$/.test(r),L=()=>{if(n.length===0||n[n.length-1].employee_id&&(n[n.length-1].employee_name||n[n.length-1].name))S([...n,{employee_id:"",whitelevel_id:E,employee_name:"",name:"",error:"",manual:!1,employee_id_error:!1,employee_name_error:!1,disableNameField:!1,invalidCharacterError:!1}]);else{const s=[...n];n[n.length-1].employee_id||(s[n.length-1].employee_id_error=!0),n[n.length-1].employee_name||n[n.length-1].name||(s[n.length-1].employee_name_error=!0),S(s)}},F=r=>{const s=n.filter((a,u)=>u!==r);S(s)},B=async(r,s)=>{const{name:a,value:u}=s.target,o=[...n];if(a==="employee_name"||a==="name")if(A(u))o[r].invalidCharacterError=!1;else{o[r].invalidCharacterError=!0,S(o);return}if(o[r][a]=u,a==="employee_id")if(o[r].employee_id_error=!1,o[r].error="",u==="0")o[r].employee_name="",o[r].manual=!0,o[r].disableNameField=!1;else{const x=o.some((v,I)=>v.employee_id===u&&I!==r);if(o[r].error=x?"duplicate":"",x)o[r].disableNameField=!0;else{const v=await b(u,E);v?(o[r].employee_name=v,o[r].manual=!1,o[r].disableNameField=!0):(o[r].error="invalid",o[r].employee_name="",o[r].disableNameField=!0)}}else if(a==="employee_name")if(u.length>0)if(o.some((v,I)=>v.employee_name===u&&I!==r))o[r].error="duplicate",o[r].disableIDField=!0;else{const v=await Y(u);k(I=>({...I,[r]:v})),T(I=>({...I,[r]:!0})),o[r].disableIDField=!1}else k(x=>({...x,[r]:[]})),T(x=>({...x,[r]:!1}));else o[r].employee_name_error=!1,a==="name"&&n[r].employee_id==="0"&&(o[r].employee_name_error=!1,o[r].error="");S(o)},P=(r,s)=>{const a=[...n];a.some((o,x)=>o.employee_name===s.employee_name&&x!==r)?(a[r].error="duplicate",a[r].employee_id_error=!0,a[r].employee_name=s.employee_name,a[r].employee_id="",a[r].disableIDField=!0):(a[r].employee_name=s.employee_name,a[r].employee_id=s.employee_id,a[r].manual=!1,a[r].error="",a[r].employee_id_error=!1,a[r].disableIDField=!1),k(o=>({...o,[r]:[]})),T(o=>({...o,[r]:!1})),S(a)},z=r=>{setTimeout(()=>{T(s=>({...s,[r]:!1}))},200)};return e.jsxs(w,{sx:{position:"relative"},children:[e.jsx(Se,{component:se,sx:{border:"1px solid lightgrey",borderRadius:"8px",boxShadow:"none"},children:e.jsxs(Ie,{children:[e.jsx(Ce,{children:e.jsxs(te,{children:[e.jsx(D,{children:"Sl. No"}),e.jsx(D,{sx:{pl:12},children:"Employee ID"}),e.jsx(D,{sx:{pl:12},children:"Employee Name"}),e.jsx(D,{sx:{pl:2},children:"Actions"})]})}),e.jsx(Ee,{children:n.map((r,s)=>e.jsxs(te,{children:[e.jsx(D,{children:s+1}),e.jsx(D,{children:e.jsx(q,{variant:"outlined",size:"small",name:"employee_id",value:r.employee_id,onChange:a=>B(s,a),fullWidth:!0,required:!0,error:!!r.error||r.employee_id_error,helperText:r.error==="duplicate"?"Duplicate employee ID":r.error==="invalid"?"Employee does not exist":r.employee_id_error?"Employee ID is required":"",disabled:r.disableIDField,onFocus:()=>T(a=>({...a,[s]:!1}))})}),e.jsxs(D,{children:[e.jsx(q,{variant:"outlined",size:"small",name:r.manual?"name":"employee_name",value:r.manual?r.name:r.employee_name,onChange:a=>B(s,a),onBlur:()=>z(s),fullWidth:!0,required:!0,disabled:r.disableNameField,error:r.employee_name_error||r.invalidCharacterError,helperText:r.invalidCharacterError?"Invalid characters in employee name":r.employee_name_error?"Employee name is required":""}),R[s]&&f[s]&&e.jsx(se,{sx:{position:"absolute",zIndex:1,maxWidth:"300px"},children:e.jsx(Te,{sx:{maxHeight:200,overflow:"auto"},children:f[s].map((a,u)=>e.jsx(ke,{button:!0,onClick:()=>P(s,a),children:`${a.employee_name}`},u))})})]}),e.jsx(D,{children:e.jsx(we,{color:"primary",onClick:()=>F(s),children:e.jsx(ge,{})})})]},s))})]})}),e.jsx(je,{color:"primary",size:"small",onClick:L,sx:{position:"absolute",bottom:-18,left:"49%",transform:"translateX(-50%)",boxShadow:"none",zIndex:1},children:e.jsx(be,{})})]})},sr=()=>{const O=oe(t=>t.userInfo),[j,V]=d.useState(O.whitelevel_id),[n,S]=d.useState(""),[E,N]=d.useState("false"),[f,k]=d.useState(""),[R,T]=d.useState(new Date().toISOString().split("T")[0]),[b,Y]=d.useState(""),[A,L]=d.useState(""),[F,B]=d.useState(""),[P,z]=d.useState(""),[r,s]=d.useState([]),[a,u]=d.useState([]),[o,x]=d.useState([]),[v,I]=d.useState(""),[K,M]=d.useState(""),[Z,$]=d.useState(!1),[$e,le]=d.useState(null),[We,qe]=d.useState({option1:!1}),[c,Q]=d.useState({accident_report_date:"",accident_id:""}),ne=t=>{I(t.target.value)},ie=async t=>{const{name:m,checked:i}=t.target;if(b){$(!0);try{const p=await H.post("/accident/accident-detail-get/",{accident_id:b,whitelevel_id:j}),l=p.data;le(l),l?(T(l.date_of_accident||new Date().toISOString().split("T")[0]),S(l.incident_type||""),B(l.permit_status||""),z(l.ppe_status||""),L(l.severity||""),N(l.toolbox_train||"false"),k(l.toolbox_refno||""),x(l.reported_by||[]),u(l.workmen||[]),s(l.supervisors||[]),I(l.about||""),M(l.accident_image),u(l.workmen.map(C=>({employee_id:C.employee_id||"0",employee_name:C.employee_name||"Others"}))),s(l.supervisors.map(C=>({employee_id:C.employee_id||"0",employee_name:C.employee_name||"Others"}))),x(l.reported_by.map(C=>({employee_id:C.employee_id||"0",employee_name:C.employee_name||"Others"})))):alert("No accident data found. Please check the reference number."),console.log("Fetched data:",p.data)}catch(p){console.error("Error fetching accident data:",p),Q({fetch:"Failed to fetch accident data. Please try again."})}finally{$(!1)}}};d.useEffect(()=>{f&&f.trim()!==""?N("true"):N("false")},[f]);const X=(t,m)=>{t==="supervisors"&&s(m),t==="workmen"&&u(m),t==="reported_by"&&x(m)},ce=t=>{S(t.target.value)},me=t=>{T(t.target.value)},de=t=>{Y(t.target.value)},pe=t=>{L(t.target.value)},ue=t=>{B(t.target.value)},he=t=>{z(t.target.value)},ye=t=>{k(t.target.value)},_e=()=>{const t={};R||(t.accident_report_date="Date is required"),b?b.length<3||b.length>21?t.accident_id="Reference Number length must be between 3 and 21 characters":/^[a-zA-Z0-9/-]+$/.test(b)?b.startsWith("Acc")||(t.accident_id='Reference Number must start with "Acc"'):t.accident_id="Reference Number can only contain letters, numbers, hyphens (-), and forward slashes (/)":t.accident_id="Reference Number is required",n||(t.accident_type="Incident Type is required"),n==="2"&&(A||(t.severity="Severity is required"),F||(t.permit_status="Permit Status is required"),P||(t.ppe_status="PPE Status is required"),E==="true"&&!f?t.toolbox_reference_number="ToolBox Reference Number is required when Tool Box Talk is Yes":f&&(f.length<3||f.length>21?t.toolbox_reference_number="ToolBox Reference Number length must be between 3 and 21 characters":/^[a-zA-Z0-9/-]+$/.test(f)||(t.toolbox_reference_number="ToolBox Reference Number can only contain letters, numbers, hyphens (-), and forward slashes (/)")));const m=(i,p)=>{p.length===0?t[i]=`${i.replace("_"," ")} is empty`:p.forEach((l,C)=>{const J={};l.employee===0||l.employee==="0"||(!l.employee||l.employee.trim()==="")&&(J.employee_id="Employee ID is required"),(!l.employee_name||l.employee_name.trim()==="")&&(J.employee_name="Employee Name is required"),Object.keys(J).length>0&&(t[i]||(t[i]=[]),t[i][C]=J)})};return a.length===0&&(t.workmen="Workmen Involved is required"),o.length>0&&m("reported_by",o),a.length>0&&m("workmen",a),r.length>0&&m("supervisors",r),Q(t),Object.keys(t).length===0},re=()=>{V(O.whitelevel_id),S(""),N("false"),k(""),T(new Date().toISOString().split("T")[0]),Y(""),L(""),B(""),z(""),s([]),u([]),x([]),I(""),M("")},fe=async t=>{if(t.preventDefault(),!_e())return;$(!0);const m={accident_reporting_date:R,accident_id:b,accident_type:parseInt(n,10),severity:parseInt(A,10),permit_status:parseInt(F,10),ppe_status:parseInt(P,10),toolbox_train:E==="true",toolbox_reference_number:f,accident_image:K,about_the_accident:v,whitelevel:j,reported_by:o.map(({employee:i,employee_name:p,whitelevel_id:l})=>({employee:i,employee_name:p,whitelevel_id:l})),workmen:a.map(({employee:i,employee_name:p,whitelevel_id:l})=>({employee:i,employee_name:p,whitelevel_id:l})),supervisors:r.map(({employee:i,employee_name:p,whitelevel_id:l})=>({employee:i,employee_name:p,whitelevel_id:l}))};console.log("Submitting the following data:"),console.log(JSON.stringify(m,null,2));try{const i=await H.post("/accident/create/",m);console.log("Success:",i.data),window.alert("Accident Form submitted successfully!"),re(m)}catch(i){if(i.isAxiosError&&i.response){console.error(`HTTP error! status: ${i}`);const p=JSON.stringify(i.response.data);console.error("Response body:",p),alert(`Error: ${p}`)}else i.name==="TypeError"?(console.error("Network error: Please check if the server is running and accessible."),alert("Network error: Please check if the server is running and accessible.")):(console.error("Error fetching data:",i),alert(`Error fetching data: ${i.message}`));console.error("Error in handleSubmit:",i.message),window.alert("Error submitting form. Please try again.")}finally{$(!1)}},xe=async t=>{t.preventDefault(),$(!0);const m={date_of_accident:R,accident_id:b,accident_type:parseInt(n,10),severity:parseInt(A,10),permit_status:parseInt(F,10),ppe_status:parseInt(P,10),toolbox_train:E==="true",toolbox_reference_number:f,accident_image:K,about_the_accident:v,whitelevel_id:j,reported_by:o.map(({employee:i,employee_name:p,whitelevel_id:l})=>({employee_id:i,employee_name:p,whitelevel_id:l})),workmen:a.map(({employee:i,employee_name:p,whitelevel_id:l})=>({employee_id:i,employee_name:p,whitelevel_id:l})),supervisors:r.map(({employee:i,employee_name:p,whitelevel_id:l})=>({employee_id:i,employee_name:p,whitelevel_id:l}))};try{const i=await H.put("accident/accident-details-update/",m);console.log("Updated Accident:",i.data),alert("Updated Accident successfully:",i.data),re()}catch(i){console.error("Error:",i),Q("An error occurred while updating the accident.")}finally{$(!1)}};return e.jsxs(Re,{children:[e.jsx(w,{className:"section",sx:{display:"flex",justifyContent:"center",padding:4},children:e.jsx("form",{onSubmit:fe,children:e.jsx(Ae,{sx:{maxwidth:"100%",padding:3,boxShadow:3},children:e.jsxs(Fe,{children:[e.jsxs(h,{container:!0,spacing:2,children:[e.jsx(h,{item:!0,xs:12,sm:5.5,children:e.jsx(q,{label:"Date",type:"date",fullWidth:!0,InputLabelProps:{shrink:!0},inputProps:{max:new Date().toISOString().split("T")[0]},value:R,onChange:me,error:!!c.accident_report_date,helperText:c.accident_report_date,required:!0})}),e.jsx(h,{item:!0,xs:12,sm:5.5,children:e.jsx(q,{label:"Reference Number",fullWidth:!0,onChange:de,value:b,error:!!c.accident_id,helperText:c.accident_id,required:!0})}),e.jsx(h,{item:!0,xs:12,sm:1,sx:{marginTop:"10px"},children:e.jsx(ee,{variant:"contained",color:"secondary",onClick:ie,fullWidth:!0,disabled:Z,children:"ok"})})]}),e.jsx(Be,{sx:{marginY:3}}),e.jsxs(W,{component:"fieldset",margin:"normal",error:!!c.accident_type,children:[e.jsx(U,{component:"legend",children:"Incident Type*:"}),e.jsxs(G,{row:!0,value:n,onChange:ce,children:[e.jsx(_,{value:"2",control:e.jsx(y,{}),label:"Accident"}),e.jsx(_,{value:"1",control:e.jsx(y,{}),label:"Near Miss"}),e.jsx(_,{value:"3",control:e.jsx(y,{}),label:" Safety Violation"})]}),c.accident_type&&e.jsx(g,{color:"error",children:c.accident_type})]}),n&&e.jsxs(h,{container:!0,spacing:2,children:[e.jsxs(h,{item:!0,xs:12,children:[e.jsx(g,{gutterBottom:!0,children:"Reported By: (Enter 0 in case of Others)"}),e.jsx(ae,{onEmployeesChange:t=>X("reported_by",t),initialWhitelevelId:j,initialData:o}),Array.isArray(c.reported_by)&&c.reported_by.length>0&&e.jsx(w,{children:c.reported_by.map((t,m)=>e.jsxs(w,{children:[t.employee_id&&e.jsx(g,{color:"error",children:`Employee ${m+1} ID: ${t.employee_id}`}),t.employee_name&&e.jsx(g,{color:"error",children:`Employee ${m+1} Name: ${t.employee_name}`})]},m))})]}),e.jsxs(h,{item:!0,xs:12,children:[e.jsx(g,{gutterBottom:!0,children:"Workmen Involved*: (Enter 0 in case of Others)"}),e.jsx(ae,{onEmployeesChange:t=>X("workmen",t),initialWhitelevelId:j,initialData:a}),c.workmen&&typeof c.workmen=="string"&&e.jsx(w,{children:e.jsx(g,{color:"error",children:c.workmen})}),Array.isArray(c.workmen)&&c.workmen.length>0&&e.jsx(w,{children:c.workmen.map((t,m)=>e.jsxs(w,{children:[t.employee_id&&e.jsx(g,{color:"error",children:`Employee ${m+1} ID: ${t.employee_id}`}),t.employee_name&&e.jsx(g,{color:"error",children:`Employee ${m+1} Name: ${t.employee_name}`})]},m))})]}),e.jsxs(h,{item:!0,xs:12,children:[e.jsx(g,{gutterBottom:!0,children:"Supervisor:"}),e.jsx(Ne,{onChange:t=>X("supervisors",t),initialWhitelevelId:j,initialData:r}),Array.isArray(c.supervisors)&&c.supervisors.length>0&&e.jsx(w,{children:c.supervisors.map((t,m)=>e.jsxs(w,{children:[t.employee_id&&e.jsx(g,{color:"error",children:`Supervisor ${m+1} ID: ${t.employee_id}`}),t.employee_name&&e.jsx(g,{color:"error",children:`Supervisor ${m+1} Name: ${t.employee_name}`})]},m))})]}),n&&n=="2"&&e.jsxs(e.Fragment,{children:[e.jsx(h,{item:!0,xs:12,children:e.jsxs(W,{component:"fieldset",error:!!c.severity,children:[e.jsx(U,{component:"legend",children:"Severity*"}),e.jsxs(G,{row:!0,value:A,onChange:pe,children:[e.jsx(_,{value:"1",control:e.jsx(y,{}),label:"1"}),e.jsx(_,{value:"2",control:e.jsx(y,{}),label:"2"}),e.jsx(_,{value:"3",control:e.jsx(y,{}),label:"3"}),e.jsx(_,{value:"4",control:e.jsx(y,{}),label:"4"}),e.jsx(_,{value:"5",control:e.jsx(y,{}),label:"5"})]}),c.severity&&e.jsx(g,{color:"error",children:c.severity})]})}),e.jsx(h,{item:!0,xs:12,children:e.jsxs(W,{component:"fieldset",error:!!c.permit_status,children:[e.jsx(U,{component:"legend",children:"Permit Status*"}),e.jsxs(G,{row:!0,value:F,onChange:ue,children:[e.jsx(_,{value:"4",control:e.jsx(y,{}),label:"Valid"}),e.jsx(_,{value:"3",control:e.jsx(y,{}),label:"Not Required"}),e.jsx(_,{value:"2",control:e.jsx(y,{}),label:"No Permit"}),e.jsx(_,{value:"1",control:e.jsx(y,{}),label:"Expired"})]}),c.permit_status&&e.jsx(g,{color:"error",children:c.permit_status})]})}),e.jsx(h,{item:!0,xs:12,sm:6,children:e.jsxs(W,{component:"fieldset",error:!!c.ppe_status,children:[e.jsx(U,{component:"legend",children:"PPE Status*"}),e.jsxs(G,{row:!0,value:P,onChange:he,children:[e.jsx(_,{value:"2",control:e.jsx(y,{}),label:"OK"}),e.jsx(_,{value:"1",control:e.jsx(y,{}),label:"Faulty"})]}),c.ppe_status&&e.jsx(g,{color:"error",children:c.ppe_status})]})}),e.jsxs(h,{item:!0,xs:12,sm:6,children:[e.jsxs(W,{component:"fieldset",children:[e.jsx(U,{component:"legend",children:"Tool Box Talk*"}),e.jsxs(G,{row:!0,value:E,onChange:t=>N(t.target.value),children:[e.jsx(_,{value:"true",control:e.jsx(y,{}),label:"Yes"}),e.jsx(_,{value:"false",control:e.jsx(y,{}),label:"No"})]})]}),E==="true"&&e.jsx(q,{label:"ToolBox Reference Number",fullWidth:!0,onChange:ye,value:f,sx:{marginTop:2},error:!!c.toolbox_reference_number,helperText:c.toolbox_reference_number})]})]}),e.jsx(h,{item:!0,xs:12,children:e.jsx(W,{fullWidth:!0,margin:"normal",children:e.jsx(q,{label:"Description....",multiline:!0,rows:4,value:v,onChange:ne})})}),e.jsx(h,{item:!0,xs:12,children:e.jsx(ve,{setCompressedImageBase64:M,compressedImageBase64:K})})]}),e.jsxs(h,{container:!0,spacing:2,sx:{marginTop:"20px"},children:[e.jsx(h,{item:!0,xs:12,md:6,children:e.jsx(ee,{variant:"contained",color:"primary",type:"submit",fullWidth:!0,disabled:Z,children:"Submit Accident"})}),e.jsx(h,{item:!0,xs:12,md:6,children:e.jsx(ee,{variant:"contained",color:"secondary",onClick:xe,fullWidth:!0,disabled:Z,children:"Update Accident"})})]})]})})})}),e.jsx(De,{open:Z,sx:{color:"#fff",zIndex:t=>t.zIndex.drawer+1},children:e.jsx(Pe,{color:"inherit"})})]})};export{sr as default};
